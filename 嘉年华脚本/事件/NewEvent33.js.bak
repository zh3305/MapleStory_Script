/* 
 * 米纳尔西部森林副本
 */
var BOSS = Array(
				  Array(9300304,300000000000,"SS"),//SS级怪物ID、怪物血量

				  Array(9300293,100000000000,"S"),//S级怪物ID、怪物血量
				  Array(9300294,100000000000,"S"),//S级怪物ID、怪物血量

				  Array(9300291,30000000000,"A"),//A级怪物ID、怪物血量
				  Array(9300292,30000000000,"A"),//A级怪物ID、怪物血量
				  Array(9300291,30000000000,"A"),//A级怪物ID、怪物血量

				  Array(9801002,2000000000,"B"),//B级怪物ID、怪物血量
				  Array(9801003,2000000000,"B"),//B级怪物ID、怪物血量
				  Array(9801004,2000000000,"B"),//B级怪物ID、怪物血量
				  Array(9801005,2000000000,"B")//B级怪物ID、怪物血量
);
var BOSSMAP = Array(321123000,-45,391);//乱入出现的地图、X坐标、Y坐标
var BOSSChance = 25;//（数字÷500）×100%
function init() {
    em.setProperty("state", "0");//state = 为1代表有没有人，2代表是否有BOSS乱入
    em.setProperty("leader", "true");
}

function setup(level, leaderid) {
    em.setProperty("state", "1");
    em.setProperty("leader", "true");
    var eim = em.newInstance("NewEvent34");
    eim.setInstanceMap(321120000).resetPQ(level);
    eim.setInstanceMap(321121000).resetPQ(level);
    eim.setInstanceMap(321122000).resetPQ(level);
    eim.setInstanceMap(321123000).resetPQ(level);
    eim.setInstanceMap(321124000).resetPQ(level);
    eim.setInstanceMap(321125000).resetPQ(level);
    eim.setInstanceMap(321126000).resetPQ(level);
    var map = eim.setInstanceMap(321126000);
    map.resetFully();
    var mob = em.getMonster(9300292);
    mob.changeLevel(level);
	mob.getChangedStats().setOHp(12500000000);
    mob.setHp(12500000000);
    eim.registerMonster(mob);
    map.spawnMonsterOnGroundBelow(mob, new java.awt.Point(1208, 421));
	//----以下为BOSS乱入召唤
	var A =  Math.floor(Math.random()*BOSS.length);
	var C = BOSS[A];//取到怪物行
	var chance = Math.floor(Math.random() * 500);
	if (chance<BOSSChance||em.getProperty("state")=="3"){
		var map1 = eim.setInstanceMap(BOSSMAP[0]);
		var mob1 = em.getMonster(C[0]);
		mob1.changeLevel(level);
		mob1.getChangedStats().setOHp(C[1]);
		mob1.setHp(C[1]);
		eim.registerMonster(mob1);
		map1.spawnMonsterOnGroundBelow(mob1, new java.awt.Point(BOSSMAP[1], BOSSMAP[2]));
		em.setProperty("state", "2");
		em.broadcastServerMsg(5121027, "注意：米纳尔东部森林 "+C[4]+" 级BOSS乱入" ,true);
	}
    eim.startEventTimer(1000 * 60 * 30); //60 min
    return eim;
}

function playerEntry(eim, player) {
    var map = eim.getMapInstance(0);
    player.changeMap(map, map.getPortal(0));
    em.broadcastServerMsg(5121027, "玩家进入神木村-米纳尔东部森林副本，请在30分钟内通关拿到奖励！" ,true);
}

function playerRevive(eim, player) {
    return false;
}

function changedMap(eim, player, mapid) {
    if (mapid < 321120000 || mapid > 321126000) {
        eim.unregisterPlayer(player);
        if (eim.disposeIfPlayerBelow(0, 0)) {
            em.setProperty("state", "0");
            em.setProperty("leader", "true");
        }
    }
}

function playerDisconnected(eim, player) {
    eim.disposeIfPlayerBelow(100, 910340700);
    em.setProperty("state", "0");
    em.setProperty("leader", "true");
    return 0;
}

function monsterValue(eim, mobId) {
    return 1;
}

function playerExit(eim, player) {
    eim.unregisterPlayer(player);
    if (eim.disposeIfPlayerBelow(0, 0)) {
        em.setProperty("state", "0");
        em.setProperty("leader", "true");
    }
}
function scheduledTimeout(eim) {
    eim.disposeIfPlayerBelow(100, 910340700);
    em.setProperty("state", "0");
    em.setProperty("leader", "true");
}

function clearPQ(eim) {
    scheduledTimeout(eim);
}

function allMonstersDead(eim) {
	eim.schedule("end", 1000 * 0);
}


function allMonstersDead(eim) {
    em.broadcastServerMsg(5121027, "恭喜玩家通关米纳尔森林，请在10秒内狂点NPC获取奖励！" ,true);
    eim.startEventTimer(1000 * 10); //10 min
    eim.getMapInstance(321126000).spawnNpc(9390445, new java.awt.Point(1208, 421));
	
}

function leftParty(eim, player) {}
function disbandParty(eim) {}
function playerDead(eim, player) {}
function cancelSchedule() {}
var ca = java.util.Calendar.getInstance();
var year = ca.get(java.util.Calendar.YEAR); //获得年份
var month = ca.get(java.util.Calendar.MONTH) + 1; //获得月份
var weekday = ca.get(java.util.Calendar.DAY_OF_WEEK);//获得星期（星期天是 1 ，依次下去，星期六是 7）
var day = ca.get(java.util.Calendar.DATE);//获取日
var hour = ca.get(java.util.Calendar.HOUR_OF_DAY); //获得小时
var min = ca.get(java.util.Calendar.MINUTE);//获得分钟
var sec = ca.get(java.util.Calendar.SECOND); //获得秒
var setupTask;
var probability = 200.0;//概率即1000/10000=0.1
var Hfish = 2.0;//高级鱼饵提升倍数
var Lfish = 1.0;//普通鱼饵提升倍数
var YZ = 1.3;//钓鱼椅子提升倍数
var ff = [];
var xs = "日常";
//var fish = [4031633];
var fish = [
4031627,4031627,4031627,4031627,4031627,4031627,4031627,4031627,4031627,4031627,
4031628,4031628,4031628,4031628,4031628,4031628,4031628,4031628,4031628,4031628,
4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,
4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,
4031631,4031631,4031631,4031631,4031631,4031631,4031631,4031631,4031631,4031631,
4031633,4031633,4031633,4031633,4031633,4031633,4031633,4031633,4031633,4031633,
4031634,4031634,4031634,4031634,4031634,4031634,4031634,4031634,4031634,4031634,
4031635,4031635,4031635,4031635,4031635,4031635,4031635,4031635,4031635,4031635,
4031636,4031636,4031636,4031636,4031636,4031636,4031636,4031636,4031636,4031636,
4031637,4031637,4031637,4031637,4031637,4031637,4031637,4031637,4031637,4031637,
4031638,4031638,4031638,4031638,4031638,4031638,4031638,4031638,4031638,4031638,
4031639,4031639,4031639,4031639,4031639,4031639,4031639,4031639,4031639,4031639,
4031640,4031640,4031640,4031640,4031640,4031640,4031640,4031640,4031640,4031640,
4031641,4031641,4031641,4031641,4031641,4031641,4031641,4031641,4031641,4031641,
4031642,4031642,4031642,4031642,4031642,4031642,
4031643,4031643,4031643,4031643,4031643,4031643,
4031644,4031644,4031644,4031644,4031644,4031644,
4031645,4031645,4031645,4031645,4031645,4031645,
4031646,4031646,4031646,4031646,4031646,4031646,
4031647,4031647,4031647,4031647,4031647,4031647,
4031648,4031648,4031648,4031648,4031648,4031648,
4031627,4031627,4031627,4031627,4031627,4031627,4031627,4031627,4031627,4031627,
4031628,4031628,4031628,4031628,4031628,4031628,4031628,4031628,4031628,4031628,
4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,
4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,4031630,
4031631,4031631,4031631,4031631,4031631,4031631,4031631,4031631,4031631,4031631,
4031633,4031633,4031633,4031633,4031633,4031633,4031633,4031633,4031633,4031633,
4031634,4031634,4031634,4031634,4031634,4031634,4031634,4031634,4031634,4031634,
4031635,4031635,4031635,4031635,4031635,4031635,4031635,4031635,4031635,4031635,
4031636,4031636,4031636,4031636,4031636,4031636,4031636,4031636,4031636,4031636,
4031637,4031637,4031637,4031637,4031637,4031637,4031637,4031637,4031637,4031637,
4031638,4031638,4031638,4031638,4031638,4031638,4031638,4031638,4031638,4031638,
4031639,4031639,4031639,4031639,4031639,4031639,4031639,4031639,4031639,4031639,
4031640,4031640,4031640,4031640,4031640,4031640,4031640,4031640,4031640,4031640,
4031641,4031641,4031641,4031641,4031641,4031641,4031641,4031641,4031641,4031641,
4031642,4031642,4031642,4031642,4031642,4031642,
4031643,4031643,4031643,4031643,4031643,4031643,
4031644,4031644,4031644,4031644,4031644,4031644,
4031645,4031645,4031645,4031645,4031645,4031645,
4031646,4031646,4031646,4031646,4031646,4031646,
4031647,4031647,4031647,4031647,4031647,4031647,
4031648,4031648,4031648,4031648,4031648,4031648,
//金龙鱼
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,2431690,
//任务鱼
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,4001200,
//鱼卵
2431055,2431055,2431055,2431055,2431055,2431055,2431055,2431055,2431055,2431055,
2431055,2431055,2431055,2431055,2431055,
2431055,2431055,2431055,2431055,2431055,2431055,2431055,2431055,2431055,2431055,
2431055,2431055,2431055,2431055,2431055,
//未知的鱼
2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,
2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,
2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,
2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,2431004,
//金龙鱼召换包
2101120,2101120,2101120,2101120,2101120,2101120,2101120,2101120,2101120,2101120,
2101120,2101120,2101120,2101120,2101120,2101120,2101120,2101120,2101120,2101120,
//必成卷
2040006,2040006,2040006,//头盔防御必成卷
2040007,2040007,2040007,//头盔体力必成卷
2040303,2040303,2040303,//耳环智力必成卷
2040403,2040403,2040403,//上衣防御必成卷
2040506,2040506,2040506,//全身盔甲敏捷必成卷
2040507,2040507,2040507,//全身盔甲防御必成卷
2040603,2040603,2040603,//裤裙防御必成卷
2040709,2040709,2040709,//鞋子敏捷必成卷
2040710,2040710,2040710,//鞋子跳跃必成卷
2040711,2040711,2040711,//鞋子速度必成卷
2040806,2040806,2040806,//手套敏捷必成卷
2040903,2040903,2040903,//盾牌防御必成卷
2041024,2041024,2041024,//披风魔法防御必成卷
2041025,2041025,2041025,//披风物理防御必成卷
2043003,2043003,//单手剑攻击必成卷
2043103,2043103,//单手斧攻击必成卷
2043203,2043203,//单手钝器攻击必成卷
2043303,2043303,//短剑攻击必成卷
2043703,2043703,//短杖攻击必成卷
2043803,2043803,//长杖攻击必成卷
2044003,2044003,//双手剑攻击必成卷
2044019,2044019,//双手剑魔力必成卷
2044103,2044103,//双手斧攻击必成卷
2044203,2044203,//双手钝器攻击必成卷
2044303,2044303,//枪攻击必成卷
2044403,2044403,//矛攻击必成卷
2044503,2044503,//弓攻击必成卷
2044603,2044603,//弩攻击必成卷
2044703,2044703,//拳套攻击必成卷
2044815,2044815,//指节攻击必成卷
2044908,2044908,//短枪攻击必成卷
2049005,2049005,2049005,2049005,2049005,//白医卷轴―神
2049750,2049750,//S级潜能卷轴80% 
2049751,2049750,//S级潜能卷轴60%
//普通鱼饵，高级鱼饵
2300001,2300001,2300001,2300001,2300001,2300000,2300000,2300000,2300000,2300000,
//韩果字母
3994641,3994641,3994641,3994641,3994641,
3994642,3994642,3994642,3994642,3994642,
3994643,3994643,3994643,3994643,3994643,
3994644,3994644,3994644,3994644,3994644,
3994645,3994645,3994645,3994645,3994645,
//祝福卷轴
2340000,2340000,2340000,
//玩具
1442039,1442039,1442039,1442039,1442039,//冻冻鱼	
1442018,1442018,1442018,1442018,1442018,//冻冻鱼
1012477,//甜瓜味雪糕	
1012420,//水果草莓味雪糕	
1012419,//甜瓜味雪糕	
1012417,//巧克力雪糕	
1012418,//西瓜味雪糕	
1012416,//草莓雪糕	
1012073,//西瓜雪糕	
1012071,//巧克力雪糕	
1012072,//甜瓜雪糕	
1012070,//草莓雪糕	
1012268,//西瓜雪糕	
1012267,//甜瓜雪糕
//消耗类
2022643,2022643,2022643,2022643,//熏干青鱼 
2022645,2022645,2022645,2022645,//珍味烤绸缎鲤鱼	10分钟内跳跃力/移动速度 +10
2022646,2022646,2022646,2022646,//酱烤鲑鱼10分钟内回避率/命中率 +10
2022779,2022779,2022779,2022779,//黄油烤鱿鱼	10分钟内回避值提高400。
2022265,2022265,2022265,2022265,//金鱼面包	15分钟内物理攻击力提高30，魔法攻击力提高30。
2431046,2431046,2431046,2431046,2431046,2431046,2431046,2431046,2431046,2431046,//神秘韩果礼盒(经验)
2450021,2450021,2450021,2450021,2450021,//1.5倍经验
2003568,//高级巨人秘药 最大
2003570,2003570,2003570,2003570,//3倍巨人秘药  第二
2003571,2003571,//5倍巨人秘药  第三
2003572,2003572,2003572,2003572,2003572//巨人秘药     最小
];
var fishname = [
//能钓上来的鱼，名字
[4031627, "青鱼(3cm)"], [4031628, "剑鱼(120cm)"], [4031630, "鲤鱼(30cm)"], [4031631, "鲑鱼(150cm)"], [4031633, "青鱼(3.6cm)"], [4031634, "青鱼(5cm)"], [4031635, "青鱼(6.5cm)"], [4031636, "青鱼(10cm)"], [4031637, "鲤鱼(53cm)"], [4031638, "鲤鱼(60cm)"], [4031639, "鲤鱼(100cm)"], [4031640, "鲤鱼(113cm)"], [4031641, "剑鱼(128cm)"], [4031642, "剑鱼(131cm)"], [4031643, "剑鱼(140cm)"], [4031644, "剑鱼(148cm)"], [4031645, "鲑鱼(166cm)"], [4031646, "鲑鱼(183cm)"], [4031647, "鲑鱼(227cm)"], [4031648, "鲑鱼(288cm)"], [4001200, "小鱼"], [3994641, "韩果<M>"], [3994642, "韩果<A>"], [3994643, "韩果<P>"], [3994644, "韩果<L>"], [3994645, "韩果<E>"], [2101120, "大金鱼召唤包"], [2431055, "鱼卵"], [2049750, "S级潜能卷轴 80%"], [2049751, "S级潜能卷轴 60%"], [2040006, "头盔防御必成卷"], [2040007, "头盔体力必成卷"], [2040303, "耳环智力必成卷"], [2040403, "上衣防御必成卷"], [2040506, "全身盔甲敏捷必成卷"], [2040507, "全身盔甲防御必成卷"], [2040603, "裤裙防御必成卷"], [2040709, "鞋子敏捷必成卷"], [2040710, "鞋子跳跃必成卷"], [2040711, "鞋子速度必成卷"], [2040806, "手套敏捷必成卷"], [2040903, "盾牌防御必成卷"], [2041024, "披风魔法防御必成卷"], [2041025, "披风物理防御必成卷"], [2043003, "单手剑攻击必成卷"], [2043103, "单手斧攻击必成卷"], [2043203, "单手钝器攻击必成卷"], [2043303, "短剑攻击必成卷"], [2043703, "短杖攻击必成卷"], [2043803, "长杖攻击必成卷"], [2044003, "双手剑攻击必成卷"], [2044019, "双手剑魔力必成卷"], [2044103, "双手斧攻击必成卷"], [2044203, "双手钝器攻击必成卷"], [2044303, "枪攻击必成卷"], [2044403, "矛攻击必成卷"], [2044503, "弓攻击必成卷"], [2044603, "弩攻击必成卷"], [2044703, "拳套攻击必成卷"], [2044815, "指节攻击必成卷"], [2044908, "短枪攻击必成卷"], [1012477, "甜瓜味雪糕"], [1012420, "水果草莓味雪糕"], [1012419, "甜瓜味雪糕"], [1012417, "巧克力雪糕"],[1012418, "西瓜味雪糕"], [1012416, "草莓雪糕"], [1012073, "西瓜雪糕"], [1012071, "巧克力雪糕"], [1012072, "甜瓜雪糕"], [1012070, "草莓雪糕"], [1012268, "西瓜雪糕"], [1012267, "甜瓜雪糕"], [2450021, "1.5倍经验"], [1442039, "冻冻鱼"], [1442018, "冻冻鱼"], [2049005, "白医卷轴―神"], [2431046, "神秘韩果礼盒"], [2022643, "熏干青鱼"], [2022645, "珍味烤绸缎鲤鱼"], [2022646, "酱烤鲑鱼"], [2022779, "黄油烤鱿鱼"], [2022265, "金鱼面包"], [2431004, "未知的鱼"], [2300001, "高级鱼饵"], [2300000, "鱼饵"], [2340000, "祝福卷轴"], [2003568, "高级巨人秘药"], [2003570, "3倍巨人秘药"], [2003571, "5倍巨人秘药"], [2003572, "巨人秘药"]];

function init() {
    scheduleNew();
}

function scheduleNew() {
    var cal = java.util.Calendar.getInstance();
    cal.set(java.util.Calendar.HOUR, 0);
    cal.set(java.util.Calendar.MINUTE, 0);
    cal.set(java.util.Calendar.SECOND, 0);
    var nextTime = cal.getTimeInMillis();
    while (nextTime <= java.lang.System.currentTimeMillis()) {
        nextTime += 1000 * 10;
    }
    setupTask = em.scheduleAtTimestamp("start", nextTime);
}

function cancelSchedule() {
    setupTask.cancel(true);
}

function start() {
    scheduleNew();
        var allPlayers = em.getChannelServer().getMapFactory().getMap(749050501).getCharacters();//取得当前地图上面的所有玩家
        allPlayers = allPlayers.iterator(); 
        while (allPlayers.hasNext()) {//循环每一个玩家
            var player = allPlayers.next();
            fishing(player);
    }
}

function fishing(c){
    if (getItemAmount(c, 1432039)) {
		var cc = c.getClient();
            if (getItemAmount(c, 2300001)) {
                //高级鱼饵
                em.removeById(cc, 2300001, 1,true,false);
				addFish(c, 1);
				
            } else if(getItemAmount(c, 2300000)){
                //普通鱼饵
				em.removeById(cc, 2300000, 1,true,false);
                addFish(c, 0);
				//em.removeById(cc,2300000,-1,"钓鱼");
            } else {
                c.dropMessage(5,"【钓鱼系统】你的鱼饵耗光了，请及时补充！");
            }
    } else {
        c.dropMessage(5,"【普通钓鱼场】普通钓鱼场再普通也需要一根普通鱼竿吧！");
    }
    return true;
}

//获取物品数量.
function getItemAmount(player, itemid) {
    return player.itemQuantity(itemid);
}

function addFish(c, type) { //增加鱼
    var cc = c.getClient();
	var pp = probability;
    var randNum = Math.floor(Math.random() * 10000) + 1;
    if (type) { //高级鱼饵能钓到更多的鱼.
        pp = pp * Hfish;
    }else{
		pp = pp * Lfish;
	}
	if (weekday == 6 && hour >= 10 && hour < 22) { //每周五渔友日
	    pp = pp * 2;
		xs = "渔友日";
	}
     if (fish.length > 0) {
         if (randNum<pp) {//钓到鱼了
			var randfish = Math.floor(Math.random() * fish.length);
			em.addById(cc,fish[randfish],1,"钓鱼");
			if(fish[randfish]==2431690) {
			c.dropMessage(-1,"恭喜你，你钓到了一条传说中的金龙鱼.");
			c.dropMessage(5,"["+ xs +"]【钓鱼系统】恭喜你，你钓到了一条传说中的金龙鱼.");
			em.broadcastYellowMsg("["+ xs +"]【钓鱼系统】" + " : " + "玩家 "+c.getName()+" 在普通钓鱼场钓到了 1 条金龙鱼，绝版道具换不停，赶紧加入吧~");
			} else {
            var fn = "鱼";var i=0;
			for(;i<fishname.length;i++)
			{
				if(fish[randfish]==fishname[i][0])
				{
					fn = fishname[i][1];
					break;
				}
			}
			var fishno = fish[randfish];
			if(fishno==2101120||fishno==3994641||fishno==3994642||fishno==3994643||fishno==3994644||fishno==3994645||fishno==2040006||fishno==2040007||fishno==2040303||fishno==2040403||fishno==2040506||fishno==2040507||fishno==2040603||fishno==2040709||fishno==2040710||fishno==2040711||fishno==2040806||fishno==2040903||fishno==2041024||fishno==2041025||fishno==2043003||fishno==2043103||fishno==2043203||fishno==2043303||fishno==2043703||fishno==2043803||fishno==2044003||fishno==2044019||fishno==2044103||fishno==2044203||fishno==2044303||fishno==2044403||fishno==2044503||fishno==2044603||fishno==2044703||fishno==2044815||fishno==2044908||fishno==2049750||fishno==2049751||fishno==1012477||fishno==1012420||fishno==1012419||fishno==1012417||fishno==1012418||fishno==1012416||fishno==2450021||fishno==1442039||fishno==2049005||fishno==2431046||fishno==2022643||fishno==2022645||fishno==2022646||fishno==2022779||fishno==2022265||fishno==2431004||fishno==2340000||fishno==2003568||fishno==2003570||fishno==2003571||fishno==2003572) {
			em.broadcastServerMsg("["+ xs +"]【钓鱼系统】" + " : " + "玩家 "+c.getName()+" 在钓鱼场钓到了"+fn+"，你还在等什么，跟小伙伴一起钓鱼拉~");
			}
            c.dropMessage(-1,"恭喜你，你钓到了一条"+fn+".");
			c.dropMessage(5,"["+ xs +"]【钓鱼系统】恭喜你，你钓到了一条"+fn+".");
			}
         } else {
			 //没钓到 
			if(type == 1) {
			c.dropMessage(-1,"消耗了一个高级鱼饵.但是没有钓到任何东西.");
			c.dropMessage(5,"["+ xs +"]【钓鱼系统】消耗了一个高级鱼饵.但是没有钓到任何东西.");
			} else {
			c.dropMessage(-1,"消耗了一个普通鱼饵.但是没有钓到任何东西.");
			c.dropMessage(5,"["+ xs +"]【钓鱼系统】消耗了一个普通鱼饵.但是没有钓到任何东西.");
			}
		 }
    }
	
    //gainItem(c, (getItemAmount(c, 2300001) == 0) ? 2300000 : 2300001, -1);			//优先消耗高级鱼饵
}